<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="mb-0"><i class="bi bi-receipt"></i> Gastos Únicos</h1>
    <p class="text-muted mb-0">Gestiona tus gastos puntuales</p>
  </div>
  <div class="btn-group">
    <a href="/gastos-unicos/nuevo" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> Nuevo Gasto Único
    </a>
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
      <i class="bi bi-funnel"></i> Filtros
    </button>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="#" onclick="filtrarPorPeriodo('hoy')">Hoy</a>
      <a class="dropdown-item" href="#" onclick="filtrarPorPeriodo('semana')">Esta semana</a>
      <a class="dropdown-item" href="#" onclick="filtrarPorPeriodo('mes')">Este mes</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="#" onclick="limpiarFiltros()">Limpiar filtros</a>
    </div>
  </div>
</div>

<!-- Resumen rápido -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card bg-primary text-white">
      <div class="card-body text-center">
        <h5>Total de Gastos</h5>
        <h3 id="totalGastos">$0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-success text-white">
      <div class="card-body text-center">
        <h5>Este Mes</h5>
        <h3 id="gastosMes">$0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-info text-white">
      <div class="card-body text-center">
        <h5>Promedio</h5>
        <h3 id="promedioGastos">$0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-warning text-white">
      <div class="card-body text-center">
        <h5>Cantidad</h5>
        <h3 id="cantidadGastos">0</h3>
      </div>
    </div>
  </div>
</div>

<!-- Lista de gastos mejorada -->
<div class="card shadow-sm">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Lista de Gastos (Más recientes primero)</h5>
  </div>
  <div class="card-body p-0">
    {{#if gastos.length}}
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="tablaGastos">
          <thead class="table-light">
            <tr>
              <th>
                <i class="bi bi-card-text"></i> Descripción
              </th>
              <th class="text-end">
                <i class="bi bi-currency-dollar"></i> Monto
              </th>
              <th class="text-center">
                <i class="bi bi-calendar"></i> Fecha
              </th>
              <th>
                <i class="bi bi-tag"></i> Categoría
              </th>
              <th class="text-center">
                <i class="bi bi-exclamation-circle"></i> Importancia
              </th>
              <th>
                <i class="bi bi-credit-card"></i> Pago
              </th>
              <th>
                <i class="bi bi-credit-card-2-front"></i> Tarjeta
              </th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {{#each gastos}}
              <tr class="gasto-row" data-fecha="{{this.fecha}}" data-monto="{{this.monto}}">
                <td>
                  <div class="fw-bold">{{this.descripcion}}</div>
                  {{#if this.procesado}}
                    <small class="badge bg-success">Procesado</small>
                  {{else}}
                    <small class="badge bg-warning">Pendiente</small>
                  {{/if}}
                </td>
                <td class="text-end">
                  <span class="fw-bold text-{{#if (gte this.monto 1000)}}danger{{else if (gte this.monto 500)}}warning{{else}}success{{/if}}">
                    {{formatMoney this.monto}}
                  </span>
                </td>
                <td class="text-center">
                  <span class="badge bg-light text-dark">{{formatDate this.fecha}}</span>
                </td>
                <td>
                  <span class="badge bg-primary">{{this.categoria.nombre_categoria}}</span>
                </td>
                <td class="text-center">
                  <span class="badge bg-{{#if (eq this.importancia.nombre_importancia 'Esencial')}}danger{{else if (eq this.importancia.nombre_importancia 'Deseable')}}warning{{else}}secondary{{/if}}">
                    {{this.importancia.nombre_importancia}}
                  </span>
                </td>
                <td>
                  <i class="bi bi-{{#if (contains this.tipoPago.nombre 'crédito')}}credit-card{{else if (contains this.tipoPago.nombre 'débito')}}credit-card-2-back{{else if (contains this.tipoPago.nombre 'efectivo')}}cash{{else}}bank{{/if}}"></i>
                  {{this.tipoPago.nombre}}
                </td>
                <td>
                  {{#if this.tarjeta}}
                    <span class="badge bg-info">{{this.tarjeta.nombre}}</span>
                  {{else}}
                    <span class="text-muted">-</span>
                  {{/if}}
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm">
                    <a href="/gastos-unicos/{{this.id}}" class="btn btn-info btn-sm" title="Ver detalle">
                      <i class="bi bi-eye"></i>
                    </a>
                    <a href="/gastos-unicos/editar/{{this.id}}" class="btn btn-warning btn-sm" title="Editar">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <form action="/gastos-unicos/{{this.id}}?_method=DELETE" method="POST" class="d-inline">
                      <button type="submit" class="btn btn-danger btn-sm" 
                              onclick="return confirm('¿Estás seguro de eliminar este gasto único?')" 
                              title="Eliminar">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    {{else}}
      <div class="text-center py-5">
        <i class="bi bi-receipt text-muted" style="font-size: 4rem;"></i>
        <h5 class="mt-3">No hay gastos únicos registrados</h5>
        <p class="text-muted">Comienza agregando tu primer gasto único</p>
        <a href="/gastos-unicos/nuevo" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Crear primer gasto único
        </a>
      </div>
    {{/if}}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  calcularResumen();
});

function calcularResumen() {
  const filas = document.querySelectorAll('.gasto-row');
  let total = 0;
  let totalMes = 0;
  const fechaActual = new Date();
  const mesActual = fechaActual.getMonth();
  const anioActual = fechaActual.getFullYear();
  
  filas.forEach(fila => {
    const monto = parseFloat(fila.dataset.monto) || 0;
    total += monto;
    
    const fechaGasto = new Date(fila.dataset.fecha);
    if (fechaGasto.getMonth() === mesActual && fechaGasto.getFullYear() === anioActual) {
      totalMes += monto;
    }
  });
  
  const cantidad = filas.length;
  const promedio = cantidad > 0 ? total / cantidad : 0;
  
  document.getElementById('totalGastos').textContent = '$' + total.toLocaleString();
  document.getElementById('gastosMes').textContent = '$' + totalMes.toLocaleString();
  document.getElementById('promedioGastos').textContent = '$' + Math.round(promedio).toLocaleString();
  document.getElementById('cantidadGastos').textContent = cantidad.toString();
}

function filtrarPorPeriodo(periodo) {
  const filas = document.querySelectorAll('.gasto-row');
  const hoy = new Date();
  
  filas.forEach(fila => {
    const fechaGasto = new Date(fila.dataset.fecha);
    let mostrar = true;
    
    switch(periodo) {
      case 'hoy':
        mostrar = fechaGasto.toDateString() === hoy.toDateString();
        break;
      case 'semana':
        const inicioSemana = new Date(hoy);
        inicioSemana.setDate(hoy.getDate() - hoy.getDay());
        mostrar = fechaGasto >= inicioSemana;
        break;
      case 'mes':
        mostrar = fechaGasto.getMonth() === hoy.getMonth() && 
                 fechaGasto.getFullYear() === hoy.getFullYear();
        break;
    }
    
    fila.style.display = mostrar ? '' : 'none';
  });
}

function limpiarFiltros() {
  const filas = document.querySelectorAll('.gasto-row');
  filas.forEach(fila => {
    fila.style.display = '';
  });
}
</script> 