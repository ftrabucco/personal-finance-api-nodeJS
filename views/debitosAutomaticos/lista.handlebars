<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="mb-0"><i class="bi bi-arrow-repeat"></i> Débitos Automáticos</h1>
    <p class="text-muted mb-0">Gestiona tus pagos automáticos</p>
  </div>
  <div class="btn-group">
    <a href="/debitos-automaticos/nuevo" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> Nuevo Débito Automático
    </a>
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
      <i class="bi bi-funnel"></i> Filtros
    </button>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="#" onclick="filtrarPorFrecuencia('mensual')">Mensuales</a>
      <a class="dropdown-item" href="#" onclick="filtrarPorFrecuencia('anual')">Anuales</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="#" onclick="limpiarFiltros()">Limpiar filtros</a>
    </div>
  </div>
</div>

<!-- Resumen rápido -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card bg-primary text-white">
      <div class="card-body text-center">
        <h5>Total Mensual</h5>
        <h3 id="totalMensual">$0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-success text-white">
      <div class="card-body text-center">
        <h5>Activos</h5>
        <h3 id="debitosActivos">0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-info text-white">
      <div class="card-body text-center">
        <h5>Promedio</h5>
        <h3 id="promedioDebitos">$0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-warning text-white">
      <div class="card-body text-center">
        <h5>Total</h5>
        <h3 id="totalDebitos">0</h3>
      </div>
    </div>
  </div>
</div>

<!-- Lista de débitos mejorada -->
<div class="card shadow-sm">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Lista de Débitos Automáticos</h5>
  </div>
  <div class="card-body p-0">
    {{#if debitos.length}}
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="tablaDebitos">
          <thead class="table-light">
            <tr>
              <th>
                <i class="bi bi-card-text"></i> Descripción
              </th>
              <th class="text-end">
                <i class="bi bi-currency-dollar"></i> Monto
              </th>
              <th class="text-center">
                <i class="bi bi-calendar-date"></i> Día de Pago
              </th>
              <th>
                <i class="bi bi-arrow-clockwise"></i> Frecuencia
              </th>
              <th>
                <i class="bi bi-tag"></i> Categoría
              </th>
              <th class="text-center">
                <i class="bi bi-exclamation-circle"></i> Importancia
              </th>
              <th>
                <i class="bi bi-credit-card"></i> Pago
              </th>
              <th>
                <i class="bi bi-credit-card-2-front"></i> Tarjeta
              </th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {{#each debitos}}
              <tr class="debito-row" data-frecuencia="{{this.frecuencia.nombre_frecuencia}}" data-monto="{{this.monto}}" data-activo="{{this.activo}}">
                <td>
                  <div class="fw-bold">{{this.descripcion}}</div>
                  {{#if this.activo}}
                    <small class="badge bg-success">Activo</small>
                  {{else}}
                    <small class="badge bg-secondary">Inactivo</small>
                  {{/if}}
                  {{#if this.fecha_inicio}}
                    <small class="text-muted d-block">Desde: {{this.fecha_inicio}}</small>
                  {{/if}}
                </td>
                <td class="text-end">
                  <span class="fw-bold text-{{#if (gte this.monto 5000)}}danger{{else if (gte this.monto 2000)}}warning{{else}}success{{/if}}">
                    {{formatMoney this.monto}}
                  </span>
                </td>
                <td class="text-center">
                  <span class="badge bg-light text-dark">{{formatDayOfMonth this.dia_de_pago}}</span>
                </td>
                <td>
                  <span class="badge bg-secondary">{{this.frecuencia.nombre_frecuencia}}</span>
                </td>
                <td>
                  <span class="badge bg-primary">{{this.categoria.nombre_categoria}}</span>
                </td>
                <td class="text-center">
                  <span class="badge bg-{{#if (eq this.importancia.nombre_importancia 'Necesario')}}danger{{else if (eq this.importancia.nombre_importancia 'Deseado')}}warning{{else}}secondary{{/if}}">
                    {{this.importancia.nombre_importancia}}
                  </span>
                </td>
                <td>
                  <i class="bi bi-{{#if (contains this.tipoPago.nombre 'crédito')}}credit-card{{else if (contains this.tipoPago.nombre 'débito')}}credit-card-2-back{{else if (contains this.tipoPago.nombre 'efectivo')}}cash{{else}}bank{{/if}}"></i>
                  {{this.tipoPago.nombre}}
                </td>
                <td>
                  {{#if this.tarjeta}}
                    <span class="badge bg-info">{{this.tarjeta.nombre}}</span>
                  {{else}}
                    <span class="text-muted">-</span>
                  {{/if}}
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm">
                    <a href="/debitos-automaticos/{{this.id}}" class="btn btn-info btn-sm" title="Ver detalle">
                      <i class="bi bi-eye"></i>
                    </a>
                    <a href="/debitos-automaticos/editar/{{this.id}}" class="btn btn-warning btn-sm" title="Editar">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <form action="/debitos-automaticos/{{this.id}}?_method=DELETE" method="POST" class="d-inline">
                      <button type="submit" class="btn btn-danger btn-sm" 
                              onclick="return confirm('¿Estás seguro de eliminar este débito automático?')" 
                              title="Eliminar">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    {{else}}
      <div class="text-center py-5">
        <i class="bi bi-arrow-repeat text-muted" style="font-size: 4rem;"></i>
        <h5 class="mt-3">No hay débitos automáticos registrados</h5>
        <p class="text-muted">Comienza agregando tu primer débito automático</p>
        <a href="/debitos-automaticos/nuevo" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Crear primer débito automático
        </a>
      </div>
    {{/if}}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  calcularResumen();
});

function calcularResumen() {
  const filas = document.querySelectorAll('.debito-row');
  let total = 0;
  let totalMensual = 0;
  let activos = 0;
  
  filas.forEach(fila => {
    const monto = parseFloat(fila.dataset.monto) || 0;
    const activo = fila.dataset.activo === 'true';
    const frecuencia = fila.dataset.frecuencia.toLowerCase();
    
    if (activo) {
      activos++;
      total += monto;
      
      // Calcular monto mensual equivalente
      if (frecuencia.includes('mensual')) {
        totalMensual += monto;
      } else if (frecuencia.includes('anual')) {
        totalMensual += monto / 12;
      }
    }
  });
  
  const cantidad = filas.length;
  const promedio = activos > 0 ? total / activos : 0;
  
  document.getElementById('totalMensual').textContent = '$' + Math.round(totalMensual).toLocaleString();
  document.getElementById('debitosActivos').textContent = activos.toString();
  document.getElementById('promedioDebitos').textContent = '$' + Math.round(promedio).toLocaleString();
  document.getElementById('totalDebitos').textContent = cantidad.toString();
}

function filtrarPorFrecuencia(frecuencia) {
  const filas = document.querySelectorAll('.debito-row');
  
  filas.forEach(fila => {
    const frecuenciaDebito = fila.dataset.frecuencia.toLowerCase();
    const mostrar = frecuenciaDebito.includes(frecuencia);
    fila.style.display = mostrar ? '' : 'none';
  });
}

function limpiarFiltros() {
  const filas = document.querySelectorAll('.debito-row');
  filas.forEach(fila => {
    fila.style.display = '';
  });
}
</script> 